const { Server } = require("socket.io");
const NetworkCommands = require("../../GameStatic/js/network/networkCommands");
const Protagonist = require("../protagonist");

class ServerNetworkManager {

    /**
     * 
     * @param {Protagonist[]} players 
     */
    constructor(io, players) {
        this.io = io;
        this.playerArray = players;

        var instance = this;

        io.on('connection', (socket)=>{
            console.log('a user connected');

            /**
             * on request player add: 
             * @param {Object} data 
             * @param {number} data.id -  Player id
             */
            socket.on(NetworkCommands.REQUEST_ADD_PLAYER, (data) => {
                console.log("Register: " + data);
                var newPlayer = new Protagonist(data.id, socket);
                instance.playerArray.push(newPlayer);
        
                instance.broadcastToAllPlayers(NetworkCommands.ADD_PLAYER, newPlayer.data);
            });

        });
    }


    /**
     * 
     * @param {string} command 
     * @param {Object} data 
     */
    broadcastToAllPlayers(command, data) {
        console.log('Broadcasting to all players: ' + command + "    with data   " + JSON.stringify(data));
        this.playerArray.forEach(curr => {
            curr.sendCommand(command, data);
        });
    }
}

module.exports = ServerNetworkManager;